import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.LongStream;

public class Day21 {
    public static void main(String... args) {
        for (String input : List.of(TEST_INPUT, INPUT)) {
            var board = parse(input);
            partI(board);
            partII(board);
        }
    }

    private static void partI(Board board) {
        System.out.println("Part I");

        for (var steps : List.of(6, 64)) {
            System.out.println(steps + ": " + walkI(board, steps));
        }

        System.out.println();
    }

    private static void partII(Board board) {
        var tilesAtSteps = tilesAtSteps(board, true);
        System.out.println("Part II");

        for (int steps : List.of(6, 10, 50, 100, 500, 1000, 5000, 26501365)) {
            System.out.println(steps + ": " + walkII(tilesAtSteps, steps));
        }

        System.out.println();
    }

    static long walkI(Board board, int steps) {
        var positions = Set.of(board.start());

        for (int step = 0; step < steps; step++) {
            positions = walkOneStep(board, positions, false);
        }

        return positions.size();
    }

    static long walkII(long[] tilesAtSteps, int steps) {
        if (steps < tilesAtSteps.length) {
            return tilesAtSteps[steps];
        }

        int cycleLength = 1;

        while (cycleLength < tilesAtSteps.length / 3) {
            List<Long> tilesAtCycleStart = new ArrayList<>();

            for (int step = steps % cycleLength; step < tilesAtSteps.length; step += cycleLength) {
                tilesAtCycleStart.add(tilesAtSteps[step]);
            }

            long[] firstOrderDiffs = diffs(tilesAtCycleStart.stream().mapToLong(Long::longValue).toArray());
            long[] secondOrderDiffs = diffs(firstOrderDiffs);
            long[] thirdOrderDiffs = diffs(secondOrderDiffs);

            if (allZeroes(thirdOrderDiffs)) {
                return extrapolate(steps / cycleLength, tilesAtCycleStart.get(0), firstOrderDiffs[0], secondOrderDiffs[0]);
            }

            cycleLength++;
        }

        throw new IllegalStateException();
    }

    private static long[] tilesAtSteps(Board board, @SuppressWarnings("SameParameterValue") boolean useCachedValues) {
        if (useCachedValues) {
            return (board.width() == 11 ? TEST_TILES_AT_STEPS : TILES_AT_STEPS)
                    .lines()
                    .map(line -> line.split(" ")[1])
                    .mapToLong(Long::parseLong)
                    .toArray();
        }

        System.out.println("Counting tiles at every step for 1,000 steps...");
        long[] tiles = new long[1001];
        var positions = Set.of(board.start());

        for (int step = 0; step < tiles.length; step++) {
            tiles[step] = positions.size();
            System.out.println(step + " " + positions.size());
            positions = walkOneStep(board, positions, true);
        }

        return tiles;
    }

    private static long[] diffs(long[] array) {
        var diffs = new long[array.length - 1];

        for (int i = 0; i < diffs.length; i++) {
            diffs[i] = array[i + 1] - array[i];
        }

        return diffs;
    }

    private static boolean allZeroes(long[] array) {
        return LongStream.of(array).allMatch(v -> v == 0);
    }

    private static long extrapolate(int cycles, long tilesToOffset, long tilesPerCycle, long tilesPerCycleInc) {
        long tiles = tilesToOffset;

        for (int cycle = 0; cycle < cycles; cycle++) {
            tiles += tilesPerCycle;
            tilesPerCycle += tilesPerCycleInc;
        }

        return tiles;
    }

    private static Set<Pos> walkOneStep(Board board, Set<Pos> positions, boolean wrap) {
        var nextPositions = new HashSet<Pos>();

        for (var pos : positions) {
            for (Direction d : Direction.values()) {
                var next = pos.step(d);
                var tile = board.tile(wrap ? board.wrap(next) : next);

                if (tile != null && tile != Tile.R) {
                    nextPositions.add(next);
                }
            }
        }

        return nextPositions;
    }

    static Board parse(String input) {
        var tiles = input
                .lines()
                .map(line -> line.chars()
                                 .mapToObj(c -> c == '.' ? Tile.G : c == 'S' ? Tile.S : Tile.R)
                                 .toList())
                .toList();

        return new Board(tiles, findStart(tiles), tiles.get(0).size(), tiles.size());
    }

    static Pos findStart(List<List<Tile>> map) {
        for (int y = 0; y < map.size(); y++) {
            for (int x = 0; x < map.get(y).size(); x++) {
                if (map.get(y).get(x) == Tile.S) {
                    return new Pos(x, y);
                }
            }
        }

        throw new IllegalArgumentException();
    }

    enum Direction {N, E, S, W}

    record Board(List<List<Tile>> tiles, Pos start, int width, int height) {
        public Tile tile(Pos pos) {
            if (pos.x() < 0 || pos.y() < 0 || pos.y() >= height || pos.x() >= width) {
                return null;
            }

            return tiles.get(pos.y()).get(pos.x());
        }

        public Pos wrap(Pos pos) {
            return new Pos(AocUtils.modulo(pos.x(), width), AocUtils.modulo(pos.y(), height));
        }
    }

    record Pos(int x, int y) {
        Pos step(Direction d) {
            return switch (d) {
                case N -> new Pos(x, y - 1);
                case E -> new Pos(x + 1, y);
                case S -> new Pos(x, y + 1);
                case W -> new Pos(x - 1, y);
            };
        }
    }

    enum Tile {S, G, R}

    static final String TEST_INPUT = """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........""";

    static final String INPUT = """
            ...................................................................................................................................
            ..##.#..#.....#.##......#........##.....#..#....##..................................#..#....................#.......#.##.#.......#.
            ..............#....#...#...##.....#...........#.#........................#.................#......#...........##.#.#............#..
            .......#...#..........#.#....#..........##.........#.#........................#...............#....#..#.#...........#...##...#.....
            .....#....#..#..#...........#..................#.............................#.........#.#........#...#...#..............#.........
            ...#......#......##.#....................#..#..#......#...........#................#....#......##...#...........#.....#.#......##..
            ...#...#..##......#..........#..#...........#.#......#.....................##..#.#.......................#.##........##.........#..
            ........#...#.....#....##......#...........#.#...#..#..................................#......#..##.#.........#.......#............
            ..#.###....##...#......#...........#......#........#.#.........#...#.#..............#..#.........#.........#.......##..#...........
            .#...............##...#........#......##.........#..................#..............#....#........#........#...#.............#......
            .....#.........#.......##......#.........##..#..............#......................#..#....#........###.##.#..................##...
            .#..............#.#.#.#...............#....................#..#....##.#.........##....#................#........#......#.....#.....
            ........#..#..###...........#......#.#......#..............#...#.........#.......#....#........#..##............#....#......##.....
            ...#...#....#......#....#...................#.#............##........#..........................#......##.........#..#..#..........
            .##...#............##..#.#.........##.....#..##.........................#............#.....#...#........#..#.......#.....#.........
            ..........####..#.....#....###...#.....##.....#..............#.#.............................##..#...##.##..#...#.........#........
            ............#....#...#........#........#....#..................##..#.##.................#........#....#..#........#.#.#...#..#.##..
            ...#.....#.....#..........#....#.#......#................#..###.#.#.#..##.................#...#.......##.#....#....#......#..#...#.
            .#..###.#............................#.#............#.....#.......#...#.....#..#.........#........#........#..........###.....#....
            .#...###.#.....#.........#..............................#................#...##.................#..#..#.....#.##....##.#...........
            .....#.##...#.............#........#................#.#..................#.#.#.#.........##...........##.........##.......##....#..
            .........#.#........####.#.##.....#....##.......#.......###.#.............#.................#.....#..###.#...............##......#.
            .....#............#..#...#.##....#.............#...#...#..##.......#..............#........#...##...#...............##.......#.#...
            ..###...#..#..#.#........#.........#..........#.##.#..............#.#.#.........#.##..........#.#.......................#..........
            .........#.......#......#.#..#...#...................#....#........#..............#............#..##.........#..#..#..#............
            ..#......#..##......##.#.##.###..#.#............#..#.........#............#.#......#..............#...#.##.....##.#.....#..........
            ..#......#..#.#....##...#.....##..............#...........#........###...##.....#.................##..#.....#.#......##.#...#......
            ..............#......##..##.......#.........##..#..#...............#....#..............................#......#.#.##.......#..#..#.
            ......#...............#.#......#..........##..#.....#..##...#........#..#.#..##....#...................##.##...#..........####..#..
            .........#..#.......#...........#...........#.##..................#.............#.#...................#..........#.....#.........#.
            .......#.......#..#.#.#.#..#.............##..#..........#.#...........#.........##..................#.......#.......##.........#...
            .#.....................##....#........#....#.....#....#........##..#.....#....#.......#...#..............#.................#.#..#..
            .#..........#...#...#........#.........##.....#.#..#....#...####......#....#...............#....................................#..
            ..#.#..#...#..#.............#.......##..#........#...#....#....#...##.#..........##.....#...##........#...##.....#....#..#...#.#...
            ...#...................#................#.............#.............#.......................##.........#................#...#......
            .............##....##.....................##.....#..#..#.####......##..#............#...#..................#.##.#.#..#...##.##.....
            ..#......#......#......#................#.#......##........#.#..................#.............#..#........#...........#.....##.....
            .......#..##....................#...#.#................#.................#.#.#..#...#.......#...................................#..
            .....#..#..#..#....#...........#.......##...........................#.#......#.......#......#....................##.#......#.......
            ............##......##...................##.......#.........#.#......#...#..........#..##.......#..#............#.........###....#.
            ..............................#.##........#.#.............#....#.......................#...#..#.....#.................#...#.....##.
            ..##....#....#.#....................#........................#.#.....#...#.##..#.....#......#.#..................#.................
            .##...#....##......#..........##......#...#......#....#............#...#.#.....#..............#........#............##........#..#.
            .##..............#................#..................#...#......#.....#..##........#............#....#.............#.#..####.......
            ......#......#.#...........#..#.........#.....#....#....#.....#....#.............#.......#...#.#....#...................#....#.....
            .#....#..#..............#...##.....#.........#..#.........................#..#.........#.................##........##..........##..
            .............#.#................##.#......#.....................#.#..........#.#..##.....#.##.#.#.##.#....#................#.....#.
            .......#....................#.##...................###....#...........#............#......#...........#....#..................#....
            ...##..#...............##...#.........#.#..........##...#.....##..#......#...#.#..#.......#.......#.......................#..#...#.
            ......#..#...........###.........#.#...#..........#.....#...#.##..#..........#.........#..............#...................#........
            ....#...#..#.............#...............................#...##...#......#..#....#.#............#........##.#..........###.........
            ........#........................#.#.#..............#...............#....#...#.....#..#.#....................#.............#...#...
            ..#...............#..##.....##..........#....#.###................#....#.#..#.#........##.##............#...#.#..............#.....
            .##................#.......#.............#..##........................#......##...#......#.#..........#.#.#..#..............#..#...
            ...............##..###.#......##.#......#...............#...#.##........#...#.#...#.......#..###........#.#...#............#...#...
            ..##.#.............#.........#..........##.......#....#...#.#.#...#......#.....#...#.#.........#....#......##.#...............#.#..
            .#...........#.........#..#.#...##.......#.............#..........#...##...#...#...#.....#........##...#......#.#....#.............
            .#................#...............#............##..#..#....##............#........#....#..#......#.....#......#.##...#.........#.#.
            .#.........##...#.#.##...........#..........#...#.......#...#..........#...............#.......#.......#.#.##....#..#...........#..
            ..#...........##..#.....#.......#...................#..............#...#.#...##.#.......#.#......#................#..#..........#..
            ............#............#.....#.#.#........##.......#..#..#.........#......#.............##..##......#......#..#.#................
            ........##...........#......##.......#.....#...................#...#.........#.###..........####..##.....#....#........#...........
            .........#.......#.#..........................#.#.............#......#..#.....#......#..........#.............#.....#..............
            ........#...#...#........#..#................#..#...#.......#......##.#...#.#........#............#.....#.#........#...............
            .......................#...........#...#.#.......#.........#...##......#...#..#.......................#..#......#..........#.......
            .................................................................S.................................................................
            ..........#...........#......#............................#..##.....#...#.#.#...........#..........##.......#.........#..##.#......
            .......#.....#.........##.#........#.....#....#..#.....#...#...#.......##..#.......##..#.........#..##.................#...........
            ................................##...................#.......#.......##..............#...................##......#.................
            .............#........#......##.....#...#...#..........##.......#.#........#.........#.......#....##...........#......#...#........
            ..............#................#...#....#....#..............#.........#....#...................#..........#...........#............
            ..................#...#.#..#.#...............##.....#.....#..##.......#.#...##....#.........##.............#.......................
            ............#......###.#...#...#......#....##........#..#####.#.#......#.#.#...#.#......#........#...#..#.#.#.#......#..........#..
            ....#.................##........#..#..#..........##.###...#...#.#.....##.................#...#.......#.#.............#.............
            .#...........#..#..#...#.#..........#.#.#.###............#...........#..#.................#.....#.....#..#.........................
            ...#.................##..#.#....#.......###..#.#.............#.....#....#.#.#............#.......##.....#.#..#......#........#.....
            ......#.................#.........#...#..............#.#.###..#......#...#.##..............#....##......#....#...#.............#...
            ........#..............#.#.......#.#.#...........#........................##..#....#..#...#..#.#...........#....#.#...........#....
            ..#.#.............#...............#........#.........#................##.........#....#...#.....##.......#................#..#.#.#.
            .#..#................#...#..#...........#..#.....#..........#.....#..#...#.###....###.....##..##.........#...#.....................
            ....#...#...........#.....................#..#...........##........#.......#.#.....##.......#..###...#.........................#.#.
            ....#.##.#.............##.....#.......#.#......#.##..........###..##.##...............#...##....#...#...................##.........
            ....#...................#....#.#.#.......#...........#......#........#.#.#..#.....#.#.....#.##..##.#.....#..#........##..#..#.#.#..
            ..........#................#..#.#.....#.#....#........#....##.#..................#.................#.....#...............#...#.....
            .........#...#.................................#.....#..#...........##...#.........#..#....#..#....#......#..........##....#...#...
            ...........#...#...........#.......#......#..............#........##.....#.......................##................#...........##..
            ..###......#..#.............##.##..#.#..##.......###..###...#..#...##.#...#.................#..........#............#..............
            ..#........##..#..........#.#......#..#..#...##.........#.#.................#.........#......#.#.................#........##...#...
            ..........#.................#..#..............#...........#.....#....#............##...#......#...................#........#.#.....
            ...........#.......##.........#.#..#...##...........#.....#...........#..............##.....#..##..................#..#.##..#......
            ..#.............#...#...............................#...........#...............#....................................##.....#......
            ...#......#........#...............#..#...#.......#.....###..#..#.#.#................#.#..........#.........................#..#...
            ...#................................#..#.....#......#..###.#........###...............#..........#.........#.....#.##....##........
            .................#..#...........#...#.................#..#..#..#.......#..........#.........................#......#........#......
            ...#.#...#..#..#..#......#.......#.....#.......##.....##.....#.....#.....#.....#...............#...........................#.....#.
            .#....#....##..#..#.##...#...........#.#.....#....#..................#..##....#.#..........##....................###......##.......
            ..#..#.#..............#............#..............##..............#..............#...............................#...........##.#..
            .#.....#.#.#.#..##.#.#..................#........##.#...............#....#..#.....#..###..............................#...##.#.....
            ..#......#.........##....................##..##.......#.....#..............................#...............#....#.........#........
            .....#.#.........#....##....##...............#.#.......#..........#......#..#..........#....#..........##.#.#.............#.....##.
            ..#.#.....#.........#.....#.#............#......#....#.....#...........#...............................#.....#.#...........#.....#.
            ......#......#....#...#....#............#.#....#............#..............#....#.........#.......#...#.#.......#.#.#........#.....
            .........#..#........##...................#..#...#.#.....##.............#....#......#....................#.##....##....#...........
            ..#......#...........#.#...................#......#.#..##..#...#.......#.#......#.......#.........#....#.........#.#...#.##.#.#.#..
            .......#......#..##.#........#.##.................#.#..#.#...#..........#......................#....#....#.........#......#........
            .#.#......#................#...#....#.........#.....................##..##..........##............#.#.........#.......#......#...#.
            ...#..#.#..##...#............##...............#..##..........#..........##.#...##....#........#.........##.#...#....#.........#....
            ...#....#........#.........#.....##...#...........#.###.............#............#.#..............#..#.........#.....#...#....#....
            ...........#.................##.##....#.................#..........##....#.....#...........................#...#....#.......#......
            ..#......#...#...................................#.###.##......#.....#..##................#..#.......#....##....###......#...#.....
            ....#......#.....#.#..#..........#.....#.........#.....#..#..........#......#.#.............#..##.####.#.##.......#.......###..#...
            ...........#..#...#.##.................##.............#....##...#.#......#...............#.....##...#......#..#....................
            ............###.......#.#..#............#..#............#............#...#..##....................###....##..........#.#.#....#....
            .#..#......#..#........................................#..#..#.....#.#...#.............##...........#..#...#......#....#.......#.#.
            ..............#..........#..............#...##..........###.#...#...##...............#...#.........#.#........###.........##..#....
            ........#..............##..............##....................#......#......#...........##..##.....#......#.....#.........##....#.#.
            ....#.#............#............#........#....#........#....#............#.................#...#.......#..#....#...#.......##....#.
            ........#......#.##....#.#..#.....#...#.........#.......#...........#..................##..##...###..#.##.....#....................
            .......#.#....#...#..#......#...........#.#..#...#.......#...#.##..#..................#...#....#.......#.#..............#......#...
            ...#..#..#..............#....#.#....#..#......#..#.............#...#..#..........#.......................#..#.....#.....#........#.
            ......#.#.....#.......#..#..............#......................#......................#.....#.....##.......#.##..#.................
            ..#........#..#................#...........#....#............##...###............................#..#.......#..#...................
            ..#..##..#.##.....#...........##....###...#.#..#..................#.............#.....#..........#...........#...#...###...........
            .....#....#.....#.......#...#......##..............#...............##.......#....#.....#.......#....#.#........#.....#..#.....#....
            ...............##.#.........##...#....##.#.#......................................##..#..##...#.##.......##.................##.....
            ...................#.....#..........#......#.#.#.#............................##....#.##..#.#..............#...##.....#..#..#......
            .#...#...#.....#.........#..............#..........##.......................#..#..#........##..#.............##...#.........#......
            .#..#...#....##.......##...........#.##........##..##...................#...#..#...#.....#.#...#........####.#...#........#..#.#...
            ....#.......##..#....##....#.....#..#..#.#..#.#..........#...............##.#..###...#..........#...#....#...#................##...
            ......#..#......#.#.....##....#.............#.##........................#.##.#...#...#....##.......##.#..................#..#..#...
            ...................................................................................................................................""";

    static final String TEST_TILES_AT_STEPS = """
            0 1
            1 2
            2 4
            3 6
            4 9
            5 13
            6 16
            7 22
            8 30
            9 41
            10 50
            11 63
            12 74
            13 89
            14 99
            15 115
            16 129
            17 145
            18 165
            19 192
            20 216
            21 234
            22 261
            23 294
            24 326
            25 353
            26 395
            27 427
            28 460
            29 491
            30 537
            31 574
            32 605
            33 644
            34 689
            35 740
            36 784
            37 846
            38 894
            39 944
            40 989
            41 1053
            42 1107
            43 1146
            44 1196
            45 1256
            46 1324
            47 1383
            48 1464
            49 1528
            50 1594
            51 1653
            52 1735
            53 1805
            54 1853
            55 1914
            56 1988
            57 2072
            58 2145
            59 2244
            60 2324
            61 2406
            62 2479
            63 2579
            64 2665
            65 2722
            66 2794
            67 2882
            68 2982
            69 3069
            70 3186
            71 3282
            72 3380
            73 3467
            74 3585
            75 3687
            76 3753
            77 3836
            78 3938
            79 4054
            80 4155
            81 4290
            82 4402
            83 4516
            84 4617
            85 4753
            86 4871
            87 4946
            88 5040
            89 5156
            90 5288
            91 5403
            92 5556
            93 5684
            94 5814
            95 5929
            96 6083
            97 6217
            98 6301
            99 6406
            100 6536
            101 6684
            102 6813
            103 6984
            104 7128
            105 7274
            106 7403
            107 7575
            108 7725
            109 7818
            110 7934
            111 8078
            112 8242
            113 8385
            114 8574
            115 8734
            116 8896
            117 9039
            118 9229
            119 9395
            120 9497
            121 9624
            122 9782
            123 9962
            124 10119
            125 10326
            126 10502
            127 10680
            128 10837
            129 11045
            130 11227
            131 11338
            132 11476
            133 11648
            134 11844
            135 12015
            136 12240
            137 12432
            138 12626
            139 12797
            140 13023
            141 13221
            142 13341
            143 13490
            144 13676
            145 13888
            146 14073
            147 14316
            148 14524
            149 14734
            150 14919
            151 15163
            152 15377
            153 15506
            154 15666
            155 15866
            156 16094
            157 16293
            158 16554
            159 16778
            160 17004
            161 17203
            162 17465
            163 17695
            164 17833
            165 18004
            166 18218
            167 18462
            168 18675
            169 18954
            170 19194
            171 19436
            172 19649
            173 19929
            174 20175
            175 20322
            176 20504
            177 20732
            178 20992
            179 21219
            180 21516
            181 21772
            182 22030
            183 22257
            184 22555
            185 22817
            186 22973
            187 23166
            188 23408
            189 23684
            190 23925
            191 24240
            192 24512
            193 24786
            194 25027
            195 25343
            196 25621
            197 25786
            198 25990
            199 26246
            200 26538
            201 26793
            202 27126
            203 27414
            204 27704
            205 27959
            206 28293
            207 28587
            208 28761
            209 28976
            210 29246
            211 29554
            212 29823
            213 30174
            214 30478
            215 30784
            216 31053
            217 31405
            218 31715
            219 31898
            220 32124
            221 32408
            222 32732
            223 33015
            224 33384
            225 33704
            226 34026
            227 34309
            228 34679
            229 35005
            230 35197
            231 35434
            232 35732
            233 36072
            234 36369
            235 36756
            236 37092
            237 37430
            238 37727
            239 38115
            240 38457
            241 38658
            242 38906
            243 39218
            244 39574
            245 39885
            246 40290
            247 40642
            248 40996
            249 41307
            250 41713
            251 42071
            252 42281
            253 42540
            254 42866
            255 43238
            256 43563
            257 43986
            258 44354
            259 44724
            260 45049
            261 45473
            262 45847
            263 46066
            264 46336
            265 46676
            266 47064
            267 47403
            268 47844
            269 48228
            270 48614
            271 48953
            272 49395
            273 49785
            274 50013
            275 50294
            276 50648
            277 51052
            278 51405
            279 51864
            280 52264
            281 52666
            282 53019
            283 53479
            284 53885
            285 54122
            286 54414
            287 54782
            288 55202
            289 55569
            290 56046
            291 56462
            292 56880
            293 57247
            294 57725
            295 58147
            296 58393
            297 58696
            298 59078
            299 59514
            300 59895
            301 60390
            302 60822
            303 61256
            304 61637
            305 62133
            306 62571
            307 62826
            308 63140
            309 63536
            310 63988
            311 64383
            312 64896
            313 65344
            314 65794
            315 66189
            316 66703
            317 67157
            318 67421
            319 67746
            320 68156
            321 68624
            322 69033
            323 69564
            324 70028
            325 70494
            326 70903
            327 71435
            328 71905
            329 72178
            330 72514
            331 72938
            332 73422
            333 73845
            334 74394
            335 74874
            336 75356
            337 75779
            338 76329
            339 76815
            340 77097
            341 77444
            342 77882
            343 78382
            344 78819
            345 79386
            346 79882
            347 80380
            348 80817
            349 81385
            350 81887
            351 82178
            352 82536
            353 82988
            354 83504
            355 83955
            356 84540
            357 85052
            358 85566
            359 86017
            360 86603
            361 87121
            362 87421
            363 87790
            364 88256
            365 88788
            366 89253
            367 89856
            368 90384
            369 90914
            370 91379
            371 91983
            372 92517
            373 92826
            374 93206
            375 93686
            376 94234
            377 94713
            378 95334
            379 95878
            380 96424
            381 96903
            382 97525
            383 98075
            384 98393
            385 98784
            386 99278
            387 99842
            388 100335
            389 100974
            390 101534
            391 102096
            392 102589
            393 103229
            394 103795
            395 104122
            396 104524
            397 105032
            398 105612
            399 106119
            400 106776
            401 107352
            402 107930
            403 108437
            404 109095
            405 109677
            406 110013
            407 110426
            408 110948
            409 111544
            410 112065
            411 112740
            412 113332
            413 113926
            414 114447
            415 115123
            416 115721
            417 116066
            418 116490
            419 117026
            420 117638
            421 118173
            422 118866
            423 119474
            424 120084
            425 120619
            426 121313
            427 121927
            428 122281
            429 122716
            430 123266
            431 123894
            432 124443
            433 125154
            434 125778
            435 126404
            436 126953
            437 127665
            438 128295
            439 128658
            440 129104
            441 129668
            442 130312
            443 130875
            444 131604
            445 132244
            446 132886
            447 133449
            448 134179
            449 134825
            450 135197
            451 135654
            452 136232
            453 136892
            454 137469
            455 138216
            456 138872
            457 139530
            458 140107
            459 140855
            460 141517
            461 141898
            462 142366
            463 142958
            464 143634
            465 144225
            466 144990
            467 145662
            468 146336
            469 146927
            470 147693
            471 148371
            472 148761
            473 149240
            474 149846
            475 150538
            476 151143
            477 151926
            478 152614
            479 153304
            480 153909
            481 154693
            482 155387
            483 155786
            484 156276
            485 156896
            486 157604
            487 158223
            488 159024
            489 159728
            490 160434
            491 161053
            492 161855
            493 162565
            494 162973
            495 163474
            496 164108
            497 164832
            498 165465
            499 166284
            500 167004
            501 167726
            502 168359
            503 169179
            504 169905
            505 170322
            506 170834
            507 171482
            508 172222
            509 172869
            510 173706
            511 174442
            512 175180
            513 175827
            514 176665
            515 177407
            516 177833
            517 178356
            518 179018
            519 179774
            520 180435
            521 181290
            522 182042
            523 182796
            524 183457
            525 184313
            526 185071
            527 185506
            528 186040
            529 186716
            530 187488
            531 188163
            532 189036
            533 189804
            534 190574
            535 191249
            536 192123
            537 192897
            538 193341
            539 193886
            540 194576
            541 195364
            542 196053
            543 196944
            544 197728
            545 198514
            546 199203
            547 200095
            548 200885
            549 201338
            550 201894
            551 202598
            552 203402
            553 204105
            554 205014
            555 205814
            556 206616
            557 207319
            558 208229
            559 209035
            560 209497
            561 210064
            562 210782
            563 211602
            564 212319
            565 213246
            566 214062
            567 214880
            568 215597
            569 216525
            570 217347
            571 217818
            572 218396
            573 219128
            574 219964
            575 220695
            576 221640
            577 222472
            578 223306
            579 224037
            580 224983
            581 225821
            582 226301
            583 226890
            584 227636
            585 228488
            586 229233
            587 230196
            588 231044
            589 231894
            590 232639
            591 233603
            592 234457
            593 234946
            594 235546
            595 236306
            596 237174
            597 237933
            598 238914
            599 239778
            600 240644
            601 241403
            602 242385
            603 243255
            604 243753
            605 244364
            606 245138
            607 246022
            608 246795
            609 247794
            610 248674
            611 249556
            612 250329
            613 251329
            614 252215
            615 252722
            616 253344
            617 254132
            618 255032
            619 255819
            620 256836
            621 257732
            622 258630
            623 259417
            624 260435
            625 261337
            626 261853
            627 262486
            628 263288
            629 264204
            630 265005
            631 266040
            632 266952
            633 267866
            634 268667
            635 269703
            636 270621
            637 271146
            638 271790
            639 272606
            640 273538
            641 274353
            642 275406
            643 276334
            644 277264
            645 278079
            646 279133
            647 280067
            648 280601
            649 281256
            650 282086
            651 283034
            652 283863
            653 284934
            654 285878
            655 286824
            656 287653
            657 288725
            658 289675
            659 290218
            660 290884
            661 291728
            662 292692
            663 293535
            664 294624
            665 295584
            666 296546
            667 297389
            668 298479
            669 299445
            670 299997
            671 300674
            672 301532
            673 302512
            674 303369
            675 304476
            676 305452
            677 306430
            678 307287
            679 308395
            680 309377
            681 309938
            682 310626
            683 311498
            684 312494
            685 313365
            686 314490
            687 315482
            688 316476
            689 317347
            690 318473
            691 319471
            692 320041
            693 320740
            694 321626
            695 322638
            696 323523
            697 324666
            698 325674
            699 326684
            700 327569
            701 328713
            702 329727
            703 330306
            704 331016
            705 331916
            706 332944
            707 333843
            708 335004
            709 336028
            710 337054
            711 337953
            712 339115
            713 340145
            714 340733
            715 341454
            716 342368
            717 343412
            718 344325
            719 345504
            720 346544
            721 347586
            722 348499
            723 349679
            724 350725
            725 351322
            726 352054
            727 352982
            728 354042
            729 354969
            730 356166
            731 357222
            732 358280
            733 359207
            734 360405
            735 361467
            736 362073
            737 362816
            738 363758
            739 364834
            740 365775
            741 366990
            742 368062
            743 369136
            744 370077
            745 371293
            746 372371
            747 372986
            748 373740
            749 374696
            750 375788
            751 376743
            752 377976
            753 379064
            754 380154
            755 381109
            756 382343
            757 383437
            758 384061
            759 384826
            760 385796
            761 386904
            762 387873
            763 389124
            764 390228
            765 391334
            766 392303
            767 393555
            768 394665
            769 395298
            770 396074
            771 397058
            772 398182
            773 399165
            774 400434
            775 401554
            776 402676
            777 403659
            778 404929
            779 406055
            780 406697
            781 407484
            782 408482
            783 409622
            784 410619
            785 411906
            786 413042
            787 414180
            788 415177
            789 416465
            790 417607
            791 418258
            792 419056
            793 420068
            794 421224
            795 422235
            796 423540
            797 424692
            798 425846
            799 426857
            800 428163
            801 429321
            802 429981
            803 430790
            804 431816
            805 432988
            806 434013
            807 435336
            808 436504
            809 437674
            810 438699
            811 440023
            812 441197
            813 441866
            814 442686
            815 443726
            816 444914
            817 445953
            818 447294
            819 448478
            820 449664
            821 450703
            822 452045
            823 453235
            824 453913
            825 454744
            826 455798
            827 457002
            828 458055
            829 459414
            830 460614
            831 461816
            832 462869
            833 464229
            834 465435
            835 466122
            836 466964
            837 468032
            838 469252
            839 470319
            840 471696
            841 472912
            842 474130
            843 475197
            844 476575
            845 477797
            846 478493
            847 479346
            848 480428
            849 481664
            850 482745
            851 484140
            852 485372
            853 486606
            854 487687
            855 489083
            856 490321
            857 491026
            858 491890
            859 492986
            860 494238
            861 495333
            862 496746
            863 497994
            864 499244
            865 500339
            866 501753
            867 503007
            868 503721
            869 504596
            870 505706
            871 506974
            872 508083
            873 509514
            874 510778
            875 512044
            876 513153
            877 514585
            878 515855
            879 516578
            880 517464
            881 518588
            882 519872
            883 520995
            884 522444
            885 523724
            886 525006
            887 526129
            888 527579
            889 528865
            890 529597
            891 530494
            892 531632
            893 532932
            894 534069
            895 535536
            896 536832
            897 538130
            898 539267
            899 540735
            900 542037
            901 542778
            902 543686
            903 544838
            904 546154
            905 547305
            906 548790
            907 550102
            908 551416
            909 552567
            910 554053
            911 555371
            912 556121
            913 557040
            914 558206
            915 559538
            916 560703
            917 562206
            918 563534
            919 564864
            920 566029
            921 567533
            922 568867
            923 569626
            924 570556
            925 571736
            926 573084
            927 574263
            928 575784
            929 577128
            930 578474
            931 579653
            932 581175
            933 582525
            934 583293
            935 584234
            936 585428
            937 586792
            938 587985
            939 589524
            940 590884
            941 592246
            942 593439
            943 594979
            944 596345
            945 597122
            946 598074
            947 599282
            948 600662
            949 601869
            950 603426
            951 604802
            952 606180
            953 607387
            954 608945
            955 610327
            956 611113
            957 612076
            958 613298
            959 614694
            960 615915
            961 617490
            962 618882
            963 620276
            964 621497
            965 623073
            966 624471
            967 625266
            968 626240
            969 627476
            970 628888
            971 630123
            972 631716
            973 633124
            974 634534
            975 635769
            976 637363
            977 638777
            978 639581
            979 640566
            980 641816
            981 643244
            982 644493
            983 646104
            984 647528
            985 648954
            986 650203
            987 651815
            988 653245
            989 654058
            990 655054
            991 656318
            992 657762
            993 659025
            994 660654
            995 662094
            996 663536
            997 664799
            998 666429
            999 667875
            1000 668697""";

    static final String TILES_AT_STEPS = """
            0 1
            1 4
            2 8
            3 15
            4 20
            5 30
            6 40
            7 51
            8 63
            9 81
            10 98
            11 120
            12 138
            13 159
            14 180
            15 209
            16 235
            17 262
            18 290
            19 317
            20 358
            21 386
            22 434
            23 460
            24 520
            25 543
            26 608
            27 640
            28 708
            29 739
            30 801
            31 840
            32 910
            33 952
            34 1018
            35 1063
            36 1141
            37 1186
            38 1268
            39 1325
            40 1406
            41 1472
            42 1545
            43 1612
            44 1693
            45 1760
            46 1845
            47 1921
            48 2011
            49 2088
            50 2184
            51 2254
            52 2344
            53 2413
            54 2514
            55 2591
            56 2699
            57 2785
            58 2891
            59 2982
            60 3087
            61 3185
            62 3335
            63 3446
            64 3605
            65 3710
            66 3870
            67 3978
            68 4142
            69 4215
            70 4382
            71 4460
            72 4630
            73 4701
            74 4876
            75 4950
            76 5126
            77 5214
            78 5383
            79 5486
            80 5643
            81 5762
            82 5925
            83 6042
            84 6206
            85 6330
            86 6496
            87 6624
            88 6798
            89 6918
            90 7098
            91 7225
            92 7406
            93 7546
            94 7729
            95 7878
            96 8060
            97 8200
            98 8387
            99 8528
            100 8722
            101 8853
            102 9051
            103 9199
            104 9425
            105 9559
            106 9784
            107 9905
            108 10140
            109 10286
            110 10514
            111 10673
            112 10900
            113 11060
            114 11294
            115 11446
            116 11679
            117 11824
            118 12070
            119 12213
            120 12465
            121 12628
            122 12884
            123 13058
            124 13301
            125 13481
            126 13702
            127 13900
            128 14132
            129 14337
            130 14558
            131 14775
            132 14997
            133 15222
            134 15434
            135 15665
            136 15879
            137 16127
            138 16315
            139 16592
            140 16797
            141 17105
            142 17303
            143 17579
            144 17764
            145 18040
            146 18243
            147 18525
            148 18745
            149 19031
            150 19251
            151 19553
            152 19752
            153 20084
            154 20271
            155 20612
            156 20795
            157 21148
            158 21351
            159 21692
            160 21890
            161 22205
            162 22424
            163 22751
            164 22981
            165 23296
            166 23526
            167 23864
            168 24098
            169 24442
            170 24688
            171 25030
            172 25283
            173 25599
            174 25857
            175 26191
            176 26447
            177 26788
            178 27059
            179 27396
            180 27669
            181 28021
            182 28271
            183 28606
            184 28839
            185 29213
            186 29445
            187 29838
            188 30082
            189 30465
            190 30729
            191 31108
            192 31376
            193 31847
            194 32173
            195 32662
            196 32976
            197 33452
            198 33768
            199 34248
            200 34490
            201 34934
            202 35176
            203 35618
            204 35838
            205 36293
            206 36519
            207 36977
            208 37223
            209 37663
            210 37933
            211 38338
            212 38645
            213 39070
            214 39380
            215 39803
            216 40121
            217 40531
            218 40851
            219 41272
            220 41579
            221 42018
            222 42330
            223 42773
            224 43098
            225 43545
            226 43889
            227 44321
            228 44641
            229 45080
            230 45404
            231 45858
            232 46154
            233 46612
            234 46944
            235 47463
            236 47757
            237 48263
            238 48529
            239 49046
            240 49366
            241 49861
            242 50208
            243 50694
            244 51040
            245 51534
            246 51869
            247 52356
            248 52669
            249 53179
            250 53484
            251 54005
            252 54349
            253 54876
            254 55236
            255 55730
            256 56099
            257 56547
            258 56952
            259 57420
            260 57835
            261 58278
            262 58711
            263 59152
            264 59598
            265 60015
            266 60472
            267 60890
            268 61376
            269 61741
            270 62283
            271 62675
            272 63274
            273 63648
            274 64182
            275 64531
            276 65062
            277 65439
            278 65977
            279 66390
            280 66934
            281 67347
            282 67910
            283 68280
            284 68896
            285 69244
            286 69866
            287 70209
            288 70850
            289 71224
            290 71838
            291 72203
            292 72771
            293 73170
            294 73754
            295 74172
            296 74736
            297 75151
            298 75749
            299 76172
            300 76778
            301 77213
            302 77816
            303 78256
            304 78815
            305 79264
            306 79851
            307 80296
            308 80893
            309 81359
            310 81943
            311 82412
            312 83020
            313 83450
            314 84030
            315 84427
            316 85074
            317 85461
            318 86139
            319 86541
            320 87201
            321 87638
            322 88291
            323 88729
            324 89521
            325 90062
            326 90881
            327 91404
            328 92196
            329 92720
            330 93516
            331 93927
            332 94648
            333 95054
            334 95768
            335 96137
            336 96872
            337 97250
            338 97990
            339 98394
            340 99105
            341 99542
            342 100195
            343 100690
            344 101377
            345 101880
            346 102562
            347 103074
            348 103728
            349 104240
            350 104908
            351 105402
            352 106100
            353 106597
            354 107302
            355 107812
            356 108523
            357 109062
            358 109744
            359 110244
            360 110935
            361 111442
            362 112156
            363 112617
            364 113335
            365 113851
            366 114663
            367 115117
            368 115904
            369 116315
            370 117114
            371 117608
            372 118370
            373 118905
            374 119650
            375 120182
            376 120936
            377 121454
            378 122195
            379 122676
            380 123450
            381 123917
            382 124707
            383 125232
            384 126030
            385 126576
            386 127321
            387 127879
            388 128554
            389 129166
            390 129870
            391 130495
            392 131160
            393 131809
            394 132469
            395 133136
            396 133758
            397 134441
            398 135063
            399 135787
            400 136329
            401 137136
            402 137715
            403 138605
            404 139155
            405 139947
            406 140460
            407 141246
            408 141797
            409 142591
            410 143197
            411 143999
            412 144605
            413 145429
            414 145970
            415 146870
            416 147379
            417 148282
            418 148785
            419 149714
            420 150259
            421 151146
            422 151678
            423 152499
            424 153078
            425 153919
            426 154525
            427 155338
            428 155938
            429 156796
            430 157408
            431 158276
            432 158900
            433 159764
            434 160391
            435 161193
            436 161833
            437 162673
            438 163307
            439 164160
            440 164821
            441 165652
            442 166317
            443 167181
            444 167791
            445 168616
            446 169177
            447 170097
            448 170639
            449 171602
            450 172162
            451 173099
            452 173709
            453 174636
            454 175244
            455 176357
            456 177113
            457 178262
            458 178994
            459 180102
            460 180834
            461 181946
            462 182526
            463 183524
            464 184094
            465 185080
            466 185598
            467 186613
            468 187143
            469 188165
            470 188727
            471 189709
            472 190313
            473 191214
            474 191897
            475 192846
            476 193542
            477 194483
            478 195189
            479 196087
            480 196791
            481 197706
            482 198387
            483 199344
            484 200026
            485 200993
            486 201688
            487 202663
            488 203397
            489 204329
            490 205009
            491 205952
            492 206642
            493 207616
            494 208242
            495 209220
            496 209920
            497 211025
            498 211639
            499 212707
            500 213263
            501 214344
            502 215012
            503 216041
            504 216764
            505 217768
            506 218486
            507 219500
            508 220201
            509 221196
            510 221845
            511 222883
            512 223512
            513 224571
            514 225277
            515 226346
            516 227078
            517 228074
            518 228821
            519 229723
            520 230542
            521 231482
            522 232317
            523 233204
            524 234069
            525 234948
            526 235836
            527 236663
            528 237572
            529 238398
            530 239360
            531 240079
            532 241151
            533 241917
            534 243098
            535 243824
            536 244874
            537 245551
            538 246592
            539 247317
            540 248367
            541 249166
            542 250226
            543 251025
            544 252110
            545 252822
            546 254006
            547 254676
            548 255860
            549 256523
            550 257740
            551 258456
            552 259616
            553 260315
            554 261389
            555 262148
            556 263246
            557 264040
            558 265102
            559 265887
            560 267005
            561 267806
            562 268936
            563 269749
            564 270874
            565 271688
            566 272733
            567 273564
            568 274657
            569 275480
            570 276589
            571 277445
            572 278523
            573 279384
            574 280504
            575 281294
            576 282364
            577 283089
            578 284282
            579 284979
            580 286227
            581 286945
            582 288159
            583 288942
            584 290143
            585 290921
            586 292355
            587 293326
            588 294805
            589 295746
            590 297170
            591 298110
            592 299538
            593 300287
            594 301562
            595 302296
            596 303554
            597 304221
            598 305516
            599 306198
            600 307502
            601 308222
            602 309475
            603 310246
            604 311395
            605 312266
            606 313477
            607 314366
            608 315566
            609 316466
            610 317608
            611 318504
            612 319666
            613 320534
            614 321750
            615 322617
            616 323846
            617 324726
            618 325965
            619 326894
            620 328076
            621 328936
            622 330131
            623 331004
            624 332238
            625 333029
            626 334267
            627 335151
            628 336549
            629 337323
            630 338672
            631 339373
            632 340736
            633 341578
            634 342874
            635 343785
            636 345048
            637 345952
            638 347226
            639 348110
            640 349359
            641 350176
            642 351478
            643 352269
            644 353597
            645 354484
            646 355824
            647 356742
            648 357989
            649 358925
            650 360054
            651 361080
            652 362256
            653 363301
            654 364410
            655 365491
            656 366589
            657 367698
            658 368730
            659 369865
            660 370895
            661 372095
            662 372991
            663 374328
            664 375281
            665 376753
            666 377655
            667 378963
            668 379804
            669 381100
            670 381999
            671 383305
            672 384297
            673 385615
            674 386607
            675 387953
            676 388836
            677 390304
            678 391135
            679 392600
            680 393423
            681 394928
            682 395815
            683 397248
            684 398114
            685 399441
            686 400380
            687 401735
            688 402717
            689 404028
            690 404998
            691 406376
            692 407366
            693 408758
            694 409760
            695 411146
            696 412147
            697 413435
            698 414457
            699 415803
            700 416815
            701 418180
            702 419231
            703 420556
            704 421613
            705 422989
            706 423959
            707 425274
            708 426163
            709 427629
            710 428481
            711 430014
            712 430890
            713 432381
            714 433337
            715 434812
            716 435760
            717 437515
            718 438701
            719 440510
            720 441660
            721 443400
            722 444548
            723 446292
            724 447210
            725 448762
            726 449660
            727 451190
            728 452006
            729 453581
            730 454415
            731 456001
            732 456879
            733 458403
            734 459341
            735 460738
            736 461797
            737 463270
            738 464352
            739 465811
            740 466905
            741 468291
            742 469379
            743 470788
            744 471843
            745 473318
            746 474370
            747 475861
            748 476926
            749 478429
            750 479553
            751 480985
            752 482025
            753 483472
            754 484528
            755 486022
            756 486978
            757 488476
            758 489544
            759 491235
            760 492169
            761 493799
            762 494645
            763 496290
            764 497306
            765 498869
            766 499968
            767 501490
            768 502580
            769 504114
            770 505181
            771 506684
            772 507669
            773 509235
            774 510188
            775 511785
            776 512853
            777 514464
            778 515568
            779 517066
            780 518191
            781 519547
            782 520780
            783 522192
            784 523447
            785 524778
            786 526075
            787 527392
            788 528722
            789 529959
            790 531320
            791 532554
            792 533992
            793 535065
            794 536667
            795 537807
            796 539570
            797 540648
            798 542214
            799 543219
            800 544770
            801 545843
            802 547405
            803 548590
            804 550166
            805 551351
            806 552958
            807 554012
            808 555764
            809 556756
            810 558502
            811 559485
            812 561278
            813 562336
            814 564042
            815 565075
            816 566655
            817 567774
            818 569386
            819 570556
            820 572116
            821 573271
            822 574909
            823 576088
            824 577742
            825 578933
            826 580580
            827 581768
            828 583299
            829 584512
            830 586111
            831 587312
            832 588933
            833 590179
            834 591751
            835 593004
            836 594636
            837 595786
            838 597346
            839 598399
            840 600138
            841 601145
            842 602963
            843 603997
            844 605765
            845 606894
            846 608643
            847 609761
            848 611837
            849 613238
            850 615377
            851 616736
            852 618792
            853 620148
            854 622208
            855 623295
            856 625124
            857 626186
            858 627988
            859 628953
            860 630808
            861 631794
            862 633662
            863 634698
            864 636493
            865 637598
            866 639243
            867 640490
            868 642225
            869 643500
            870 645218
            871 646506
            872 648136
            873 649416
            874 651072
            875 652314
            876 654048
            877 655285
            878 657038
            879 658288
            880 660055
            881 661374
            882 663056
            883 664276
            884 665975
            885 667214
            886 668968
            887 670089
            888 671847
            889 673099
            890 675083
            891 676177
            892 678088
            893 679079
            894 681006
            895 682196
            896 684026
            897 685313
            898 687094
            899 688370
            900 690164
            901 691414
            902 693171
            903 694324
            904 696154
            905 697269
            906 699135
            907 700384
            908 702266
            909 703556
            910 705305
            911 706619
            912 708202
            913 709642
            914 711290
            915 712755
            916 714308
            917 715821
            918 717357
            919 718908
            920 720350
            921 721937
            922 723375
            923 725051
            924 726301
            925 728168
            926 729495
            927 731549
            928 732803
            929 734627
            930 735796
            931 737602
            932 738849
            933 740667
            934 742045
            935 743879
            936 745257
            937 747125
            938 748350
            939 750386
            940 751539
            941 753566
            942 754709
            943 756790
            944 758019
            945 759998
            946 761198
            947 763031
            948 764330
            949 766199
            950 767557
            951 769366
            952 770706
            953 772604
            954 773972
            955 775888
            956 777268
            957 779176
            958 780551
            959 782325
            960 783729
            961 785581
            962 786971
            963 788848
            964 790289
            965 792108
            966 793557
            967 795445
            968 796775
            969 798580
            970 799797
            971 801809
            972 802971
            973 805074
            974 806266
            975 808311
            976 809613
            977 811636
            978 812924
            979 815321
            980 816937
            981 819406
            982 820974
            983 823346
            984 824910
            985 827286
            986 828542
            987 830648
            988 831874
            989 833948
            990 835062
            991 837197
            992 838335
            993 840485
            994 841679
            995 843745
            996 845017
            997 846910
            998 848345
            999 850342
            1000 851810""";
}
