import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class Day16 {
    public static void main(String... args) {
        for (String input : List.of(TEST_INPUT, INPUT)) {
            var room = parse(input);
            System.out.println("Part I: " + partI(room));
            System.out.println("Part II: " + partII(room));
        }
    }

    private static long partI(Room room) {
        return energizedTiles(room, new Beam(new Pos(0, 0), Direction.RIGHT));
    }

    private static long partII(Room room) {
        long maxEnergizedTiles = 0;

        for (int x = 0; x < room.width(); x++) {
            var top = energizedTiles(room, new Beam(new Pos(x, 0), Direction.DOWN));
            var bottom = energizedTiles(room, new Beam(new Pos(x, room.height() - 1), Direction.UP));
            maxEnergizedTiles = Math.max(Math.max(top, bottom), maxEnergizedTiles);
        }

        for (int y = 0; y < room.height; y++) {
            var left = energizedTiles(room, new Beam(new Pos(0, y), Direction.RIGHT));
            var right = energizedTiles(room, new Beam(new Pos(room.width() - 1, y), Direction.LEFT));
            maxEnergizedTiles = Math.max(Math.max(left, right), maxEnergizedTiles);
        }

        return maxEnergizedTiles;
    }

    static Room parse(String input) {
        var tiles = input.lines()
                         .map(line -> line.chars()
                                          .mapToObj(c -> switch (c) {
                                              case '.' -> Tile.EMPTY;
                                              case '/' -> Tile.F_MIRROR;
                                              case '\\' -> Tile.B_MIRROR;
                                              case '|' -> Tile.V_SLITTER;
                                              case '-' -> Tile.H_SPLITTER;
                                              default -> throw new RuntimeException();
                                          })
                                          .toArray(Tile[]::new))
                         .toArray(Tile[][]::new);

        return new Room(tiles, tiles[0].length, tiles.length);
    }

    static long energizedTiles(Room room, Beam beam) {
        Set<Beam> beams = Set.of(beam);
        Set<Beam> seen = new HashSet<>(beams);
        long seenSizeBefore;

        do {
            seenSizeBefore = seen.size();
            beams = beams.stream().flatMap(b -> b.move(room)).filter(seen::add).collect(Collectors.toSet());
        } while (!beams.isEmpty() && seen.size() > seenSizeBefore);

        return seen.stream().map(Beam::pos).distinct().count();
    }

    enum Direction {
        LEFT, UP, RIGHT, DOWN;

        boolean isVertical() {
            return this == UP || this == DOWN;
        }

        Direction next() {
            return values()[(ordinal() + 1) % 4];
        }

        Direction previous() {
            return values()[(ordinal() + 3) % 4];
        }
    }

    record Pos(int x, int y) {
        Beam next(Direction dir) {
            var nextPos = switch (dir) {
                case LEFT -> new Pos(x - 1, y);
                case UP -> new Pos(x, y - 1);
                case RIGHT -> new Pos(x + 1, y);
                case DOWN -> new Pos(x, y + 1);
            };

            return new Beam(nextPos, dir);
        }
    }

    record Beam(Pos pos, Direction dir) {
        Stream<Beam> move(Room room) {
            if (dir.isVertical()) {
                return (switch (room.tile(pos)) {
                    case EMPTY -> Stream.of(pos.next(dir));
                    case V_SLITTER -> Stream.of(pos.next(dir));
                    case H_SPLITTER -> Stream.of(pos.next(dir.previous()), pos.next(dir.next()));
                    case F_MIRROR -> Stream.of(pos.next(dir.next()));
                    case B_MIRROR -> Stream.of(pos.next(dir.previous()));
                }).filter(beam -> room.isWithin(beam.pos()));
            } else {
                return (switch (room.tile(pos)) {
                    case EMPTY -> Stream.of(pos.next(dir));
                    case V_SLITTER -> Stream.of(pos.next(dir.previous()), pos.next(dir.next()));
                    case H_SPLITTER -> Stream.of(pos.next(dir));
                    case F_MIRROR -> Stream.of(pos.next(dir.previous()));
                    case B_MIRROR -> Stream.of(pos.next(dir.next()));
                }).filter(beam -> room.isWithin(beam.pos()));
            }
        }
    }

    record Room(Tile[][] tiles, int width, int height) {
        boolean isWithin(Pos pos) {
            return pos.x >= 0 && pos.x < tiles.length && pos.y >= 0 && pos.y < tiles[0].length;
        }

        Tile tile(Pos pos) {
            return tiles[pos.y][pos.x];
        }
    }

    enum Tile {EMPTY, V_SLITTER, H_SPLITTER, F_MIRROR, B_MIRROR}

    private static final String TEST_INPUT = """
            .|...\\....
            |.-.\\.....
            .....|-...
            ........|.
            ..........
            .........\\
            ..../.\\\\..
            .-.-/..|..
            .|....-|.\\
            ..//.|....""";

    private static final String INPUT = """
            \\..|...................|........\\..............\\.................-......./........./...\\..........-......./...
            ........../...-/......\\.|............../.................\\...........\\........-.........|.....\\.-.|...........
            ...............-...........|......|...|......../.......\\............../.................................../...
            ..................................|............../..|.|.../............./..\\\\........|...|..............\\..|..
            ...........................-...-...-.......................-.....-.-....\\.......-............................/
            ........-...|.......|./../......................./.........................\\.................../.....\\........
            \\..\\............-.\\.........|../................................\\....\\......................./.............-..
            |\\...|....\\................\\...|........\\-..............|............\\.........\\.\\..|.|.......................
            .....\\.........\\......|...-...............................-.............-../.../..--......\\.....\\.............
            ................|...........................|..........\\...........././.................../............../....
            .............................\\......\\.../..|................---................-......\\....|...-............-.
            ..........|........./......\\|...|.......|........\\......\\....-....\\...-...../................/..-..../......-.
            ...|............./.................\\../....|...\\../.................|...|..|......|...........................
            ..................................-......../.....|............................................................
            ...................-.............|...-.........../...........................-..............-...............|.
            ..-.............../.............................-......-.....-.............|-...../....................../....
            ....||...../.........................................-...........................................--./-.......\\
            ...................\\..........-......./..............|\\........................../.-.|..............-..-/...|.
            .-............-............../..-........../.......................\\...-...||........./.-.....-....../........
            .......-.......-........................................../\\\\.......|......./../..\\........\\..-.........../../
            ....../../.......................\\.........\\-....\\.|..................\\......................./...-\\..........
            \\.......-........\\...-.....................\\....-........./-...|......|.......-........................\\...\\..
            ...|\\.................................../..../..........|......-......../-..|......./..........\\../..|......-\\
            ..........\\...........................|..-........-/-......../....|...............................\\.....|.....
            ..............\\......-............................-.../........|........................./........-...........
            .............-..\\.//.....................-....-......|....../....-............................/..............|
            \\........../....|................./.....\\......\\.../.................|........\\............../................
            .....-........-/|.........\\.....-./............|...\\.|......|.......|...................\\\\.....\\.............-
            ................|.-...-.....................|..........-....\\....\\......../...............................././
            ...........|.......\\..............\\......................................./........-..........................
            ...........................-..../............|............................|...........\\.......................
            ....................|..........|..................../...........\\.....|.........-............\\.\\...-..\\.......
            ................................-......-......\\.....-/......\\...\\................/................-...........
            ..|.....\\..\\......|../....................................................\\\\......-...../..../..............//
            .........\\.................\\..\\..-.-..................\\.....\\..\\.....\\..........-.............................
            ...................\\............/..\\............|.............../..\\............................|\\.\\...../....
            ......|...............\\.......|......|/........|....-.......|...........-.../.\\....\\.....|./.......|..........
            ....\\/|................-.-..........|.................../..............|../-...|/..........|..................
            ..|........./-\\.............|...|............|......\\...................\\..../.........|...............|.-....
            ...................-................\\....|/....-...|......./....../..........-|............/......\\../..\\\\....
            ...........................-..........................................-...|.|................\\../...........-.
            ......../.....|.........-.......|........./-............|../.......|......-.-.-.......................-..|-...
            .........|-...............|............./.....|........../..|........\\..........|/.............../-...........
            ...\\.....|..|...........\\....-...\\/.........................................|...................\\......-.-....
            .../...-...|.............|.....\\...|.................................../..............\\.................../...
            ..........-.........../....|.....|..-.........../.................................-..................\\....\\/..
            ....../..............\\../......../.....-./....|../.\\....-.................../............................../.\\
            ......-.|..........................\\...............|.......-...-....../.............//...\\|................/..
            ................/.........|........................|......./..|......../-...........................\\....|....
            ........../...|.........\\...........-./......\\\\...........\\......|-......|...\\...............\\................
            ../.........................|.................-/...........--.........\\.../........................\\.........\\
            ........\\..|...|.............../...................-.........|.................\\..|......./.........-.....-|..
            \\.../.......|.............|-.../.................\\...\\..........\\...|..........\\....../......-................
            ............|.|....\\..--............-/-..................../........................-../..\\..-................
            .....................................|.................../.................................|..../..-......\\...
            ....|..............|..-.....|../.........................................|........\\.................|.........
            ..............\\..|...............\\....||........../................................\\................./.\\......
            .....................-../......./....../.................................-............\\........../............
            .....|.............../......-.\\.|........-...................|.....-........\\...-.............-....-.......-..
            ..../.....|..............\\../..............................\\........|....................|..............\\.....
            ....\\................-........\\../......|..../......................-.....|............../.../........../.....
            ....-...........................-.............|...........\\..|........|.......\\././.....|./..........\\........
            /....................\\..............\\.............................-......................../\\......../....-...
            ......\\..................-............................................./.\\...../.............\\....-....\\.\\....
            ..................................\\-............................/.......|........................-|...........
            .................../.../.......|./............\\.........\\....-.-....-../\\.........|........./...\\.............
            ......./.../....|...../|......................|.....|.....|.........|...........\\......-.\\..................|.
            ..././...........................|.......\\.|......-........./.................................................
            ........|.|.......................-....................././.......||...........|/....-....\\.......|......\\/...
            .\\.\\.....|....\\......-....|...|.....//........|..-.........-.................-........./......................
            .|.....................\\............-.................................|..../.............-....../.........../.
            .|..\\..../...............\\..................../...\\............................-....../................../.|..
            ./.\\............................/.............-...../-................\\.........\\.............|...../.........
            ..........\\...............................\\............../.........\\.....-/........./|........................
            .............\\..|....|..................................\\.........|./......................\\.........-........
            ../.....|-............|...\\................|...-....-........./........|.-..........\\.........................
            ........-............./...........--................../...............................|..|.\\....\\.............
            \\.............-\\.........................-|......|/.........\\............/...........-.../.\\........\\..\\.../..
            ......................|........\\....-../.............|......|.-...................................-|../...-...
            .............|...|.....-...........|.....-...............|...\\........................./..\\....\\..............
            ..............|.............-.........../....-..................................|......./........|............
            ...........|.-..../......................................\\....-...\\-......../........-..........-......-.....|
            ../...........-............-.../|...........-.-.............\\.............................|.............-.....
            .........../...-............../........./...................................../......-.......\\\\...............
            ........................./.||......|...../.......|....|..................-..........|......\\..................
            ............/....-./..-...........|...-..........\\....../...\\/.......|\\.....\\....|........../..\\.\\............
            .......................................-.../.......|............|........|...\\..........\\.....-...............
            /..\\|.............-...-.................................\\........\\...................\\......|....-............
            ..................\\............../........................./.........|..........\\...\\......\\..........|......|
            .../.................................................../...|............../....\\...\\...../........|.......-...
            ..................-.-..........................\\.................-......................-..\\.........-........
            ...................../\\.....\\.............\\.............../................\\.|............../........./.......
            ....................|../.\\./......................................-.../.......\\...............................
            |........................-..............................................|...............................-.....
            ....\\.\\...........\\......|.........\\/|..|....|.....\\............-...../.............................\\\\........
            ......\\....|......\\|.....-..................\\........\\.......................-............-.|..............|..
            ....|.....././.......................|......../...........-.|............./......-.|....../.....\\......|....\\.
            .........\\........|.......\\..........|........./..................\\.........................|................-
            .....\\..........\\.....-......../...|-........../...\\/|........................................................
            .../.....................\\../.........\\.|.........-..........\\...............................|...............\\
            .........-...........................................-.|...........\\......//............../..|.\\............/.
            .-|../...../.........|............./..........................|..-.\\......\\............\\................../...
            ../....../.................|..............\\.........|.\\......\\...../.......\\............\\./.......|....../..\\.
            ......../.-..-......\\.........................\\|...................................-....../...................
            ......................-....|........./\\................|......\\..-\\....../.......\\.................\\/.-\\......
            ............\\...|...............|............./...........................................\\....-.-............
            \\.........|.............................|............/.........-.....\\........\\|...-..-..\\/.../......./.......
            .............................\\.|...............\\....\\..\\-.....................\\......-...../......\\..../.....\\
            ..\\-......\\.\\........-........../........\\...............\\..................../....-....\\.\\.|.|...............
            ................|./........../.................................-.............|...................\\............""";
}
